<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ö–≤–∏–∑ –ë–∞—Ç—Ç–ª - –ú–æ–±–∏–ª—å–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Russo+One&display=swap" rel="stylesheet">
<style>
:root {
--bg-primary: #111827; /* gray-900 */
--bg-secondary: #1f2937; /* gray-800 */
--bg-tertiary: #374151; /* gray-700 */
--text-primary: #f3f4f6; /* gray-200 */
--text-secondary: #9ca3af; /* gray-400 */
--accent-primary: #4f46e5; /* indigo-600 */
--accent-secondary: #3b82f6; /* blue-500 */
}
[data-theme="light"] {
--bg-primary: #f9fafb; /* gray-50 */
--bg-secondary: #ffffff;
--bg-tertiary: #e5e7eb; /* gray-200 */
--text-primary: #1f2937; /* gray-800 */
--text-secondary: #6b7280; /* gray-500 */
}
[data-theme="ocean"] {
--bg-primary: #F0F9FF;
--bg-secondary: #E0F2FE;
--bg-tertiary: #BAE6FD;
--text-primary: #0C4A6E;
--text-secondary: #0369A1;
--accent-primary: #0284C7;
--accent-secondary: #38BDF8;
}
[data-theme="forest"] {
--bg-primary: #052e16;
--bg-secondary: #064e3b;
--bg-tertiary: #047857;
--text-primary: #d1fae5;
--text-secondary: #a7f3d0;
--accent-primary: #10b981;
--accent-secondary: #34d399;
}
[data-theme="sunset"] {
--bg-primary: #fff7ed;
--bg-secondary: #ffedd5;
--bg-tertiary: #fed7aa;
--text-primary: #7c2d12;
--text-secondary: #9a3412;
--accent-primary: #f97316;
--accent-secondary: #fb923c;
}

html, body {
height: 100%;
width: 100%;
overflow: hidden;
position: fixed;
}

body {
font-family: 'Inter', sans-serif;
background-color: var(--bg-primary);
color: var(--text-primary);
transition: background-color 0.5s, color 0.5s;
-webkit-user-select: none;
-ms-user-select: none;
user-select: none;
}
.game-title {
font-family: 'Russo One', sans-serif;
}
.screen {
animation: fadeIn 0.5s ease-in-out;
height: 100vh;
width: 100%;
display: flex;
flex-direction: column;
padding: 1.5rem; /* p-6 */
}
.screen-center {
justify-content: center;
}
.hidden { display: none !important; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}
.btn-fx {
transition: all 0.2s ease;
}
.btn-fx:hover {
transform: scale(1.03);
box-shadow: 0 8px 15px rgba(0,0,0,0.2);
}
.timer-bar-inner { transition: width 0.2s linear; }
.option-btn.correct {
animation: correct-answer 0.5s ease;
background-color: #22c55e !important;
border-color: #16a34a !important;
color: white !important;
}
.option-btn.incorrect {
animation: incorrect-answer 0.5s ease;
background-color: #ef4444 !important;
border-color: #dc2626 !important;
color: white !important;
}
@keyframes correct-answer {
0% { transform: scale(1); }
50% { transform: scale(1.05); }
100% { transform: scale(1); }
}
@keyframes incorrect-answer {
0%, 100% { transform: translateX(0); }
20% { transform: translateX(-8px); }
40% { transform: translateX(8px); }
60% { transform: translateX(-8px); }
80% { transform: translateX(8px); }
}
</style>
</head>
<body>

<div id="app-container" class="relative w-full max-w-md mx-auto h-full">

<div id="main-menu" class="screen screen-center">
<div class="text-center">
<h1 class="game-title text-6xl uppercase text-transparent bg-clip-text bg-gradient-to-r mb-12" style="color: var(--accent-primary); background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));">–ö–≤–∏–∑ –ë–∞—Ç—Ç–ª</h1>
</div>
<div class="space-y-4">
<button onclick="showScreen('category-selection')" class="w-full text-white font-bold py-4 px-6 rounded-xl text-xl shadow-lg btn-fx" style="background-color: var(--accent-primary);">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
<button onclick="showScreen('stats-screen')" class="w-full text-white font-bold py-3 px-6 rounded-xl shadow-md btn-fx" style="background-color: var(--bg-tertiary);">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
<button onclick="showScreen('rules-screen')" class="w-full text-white font-bold py-3 px-6 rounded-xl shadow-md btn-fx" style="background-color: var(--bg-tertiary);">–ü—Ä–∞–≤–∏–ª–∞</button>
<button onclick="showScreen('themes-screen')" class="w-full text-white font-bold py-3 px-6 rounded-xl shadow-md btn-fx" style="background-color: var(--bg-tertiary);">–¢–µ–º—ã</button>
</div>
</div>

<div id="category-selection" class="screen hidden">
<h2 class="game-title text-4xl font-bold text-center mb-8 flex-shrink-0">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
<div id="category-grid" class="grid grid-cols-1 gap-4 flex-grow overflow-y-auto pr-2">
</div>
<div class="text-center mt-8 flex-shrink-0">
<button onclick="showScreen('main-menu')" class="font-bold py-3 px-8 rounded-lg w-full" style="background-color: var(--bg-tertiary);">–ù–∞–∑–∞–¥</button>
</div>
</div>

<div id="game-screen" class="screen screen-center p-4 hidden">
<div class="w-full p-6 rounded-2xl shadow-2xl" style="background-color: var(--bg-secondary);">
<div class="flex justify-between items-center mb-6">
<div id="question-counter" class="text-sm font-semibold px-3 py-1 rounded-full" style="background-color: var(--bg-tertiary);"></div>
<div id="score" class="text-lg font-bold" style="color: var(--accent-primary);">–û—á–∫–∏: 0</div>
<button onclick="togglePause()" class="p-2 rounded-full" style="background-color: var(--bg-tertiary);">
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
</button>
</div>
<div class="w-full h-2.5 mb-4 rounded-full" style="background-color: var(--bg-tertiary);">
<div id="timer-bar" class="h-2.5 rounded-full timer-bar-inner" style="width: 100%; background-color: var(--accent-secondary);"></div>
</div>
<div class="min-h-[120px] flex items-center justify-center">
<h3 id="question-text" class="text-xl font-semibold text-center mb-6"></h3>
</div>
<div id="options-container" class="grid grid-cols-1 gap-3"></div>
</div>
</div>

<div id="stats-screen" class="screen hidden">
<h2 class="game-title text-4xl font-bold text-center flex-shrink-0 pb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<div id="stats-content" class="flex-grow overflow-y-auto space-y-4 pr-2">
</div>
<div class="pt-6 flex-shrink-0">
<button onclick="showScreen('main-menu')" class="w-full font-bold py-3 px-4 rounded-lg" style="background-color: var(--bg-tertiary);">–ù–∞–∑–∞–¥</button>
</div>
</div>

<div id="game-over-screen" class="screen screen-center hidden">
<div class="p-8 rounded-2xl shadow-2xl text-center" style="background-color: var(--bg-secondary);">
<h2 class="game-title text-4xl font-bold mb-2">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
<p class="mb-6" style="color: var(--text-secondary);">–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</p>
<div class="mb-6">
<p class="text-lg">–í–∞—à –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç:</p>
<p id="final-score" class="text-6xl font-black my-2" style="color: var(--accent-primary);">0</p>
</div>
<div id="results-summary" class="text-left space-y-2 mb-8 p-4 rounded-lg" style="background-color: var(--bg-primary);"></div>
<div class="space-y-3">
<button onclick="restartGame()" class="w-full text-white font-bold py-3 px-6 rounded-lg" style="background-color: var(--accent-primary);">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
<button onclick="showScreen('category-selection')" class="w-full font-bold py-3 px-6 rounded-lg" style="background-color: var(--bg-tertiary);">–í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
<button onclick="showScreen('main-menu')" class="w-full font-bold py-2 px-6 rounded-lg" style="background-color: var(--bg-tertiary);">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</div>
</div>
</div>

<div id="rules-screen" class="screen screen-center hidden">
<div class="p-8 rounded-2xl shadow-2xl" style="background-color: var(--bg-secondary);">
<h2 class="game-title text-3xl font-bold text-center mb-6">–ü—Ä–∞–≤–∏–ª–∞ –ò–≥—Ä—ã</h2>
<div class="space-y-4 text-lg" style="color: var(--text-secondary);">
<p>‚úîÔ∏è –¶–µ–ª—å –∏–≥—Ä—ã - –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ <strong>15 –≤–æ–ø—Ä–æ—Å–æ–≤</strong> –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>
<p>‚è±Ô∏è –ù–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–∞–µ—Ç—Å—è <strong>20 —Å–µ–∫—É–Ω–¥</strong>.</p>
<p>üíØ –ó–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <strong>100 –æ—á–∫–æ–≤</strong>.</p>
<p>üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è <strong>–±–æ–Ω—É—Å–Ω—ã–µ –æ—á–∫–∏ –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å</strong>: +5 –æ—á–∫–æ–≤ –∑–∞ –∫–∞–∂–¥—É—é –æ—Å—Ç–∞–≤—à—É—é—Å—è —Å–µ–∫—É–Ω–¥—É.</p>
<p>üèÜ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –∑–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å - <strong>200</strong>.</p>
</div>
<div class="text-center mt-8">
<button onclick="showScreen('main-menu')" class="font-bold py-3 px-12 rounded-lg" style="background-color: var(--bg-tertiary);">–ü–æ–Ω—è—Ç–Ω–æ</button>
</div>
</div>
</div>

<div id="themes-screen" class="screen screen-center hidden">
<h2 class="game-title text-4xl font-bold text-center mb-8">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h2>
<div class="space-y-4 w-full">
<button onclick="setTheme('light')" class="w-full font-bold py-4 rounded-xl border-2" style="background-color: #f9fafb; color: #1f2937; border-color: #1f2937;">–°–≤–µ—Ç–ª–∞—è</button>
<button onclick="setTheme('dark')" class="w-full font-bold py-4 rounded-xl border-2" style="background-color: #111827; color: #f3f4f6; border-color: #f3f4f6;">–¢–µ–º–Ω–∞—è</button>
<button onclick="setTheme('ocean')" class="w-full font-bold py-4 rounded-xl border-2" style="background-color: #F0F9FF; color: #0C4A6E; border-color: #0C4A6E;">–û–∫–µ–∞–Ω</button>
<button onclick="setTheme('forest')" class="w-full font-bold py-4 rounded-xl border-2" style="background-color: #052e16; color: #d1fae5; border-color: #d1fae5;">–õ–µ—Å</button>
<button onclick="setTheme('sunset')" class="w-full font-bold py-4 rounded-xl border-2" style="background-color: #fff7ed; color: #7c2d12; border-color: #7c2d12;">–ó–∞–∫–∞—Ç</button>
</div>
<div class="text-center mt-8 w-full">
<button onclick="showScreen('main-menu')" class="font-bold py-3 px-8 rounded-lg w-full" style="background-color: var(--bg-tertiary);">–ù–∞–∑–∞–¥</button>
</div>
</div>

<div id="pause-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center space-y-6 z-50" style="animation: fadeIn 0.3s;">
<h2 class="game-title text-5xl font-bold text-white">–ü–∞—É–∑–∞</h2>
<div class="w-full max-w-xs space-y-4 px-4">
<button onclick="togglePause()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
<button onclick="restartGame()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg text-lg">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
<button onclick="showScreen('main-menu')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg text-lg">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</div>
</div>
</div>

<script>
// --- –ë–ê–ó–ê –í–û–ü–†–û–°–û–í (—Å–≤–µ—Ä–Ω—É—Ç–∞) ---
const questions = { /* ... –±–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–≤–µ—Ä–Ω—É—Ç–∞ ... */ };

// --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ---
const STATS_VK_KEY = 'quizBattleStats_v1';
const appState = {
    currentScreen: 'main-menu',
    currentCategory: '',
    currentQuestionIndex: 0,
    score: 0,
    correctAnswers: 0,
    incorrectAnswers: 0,
    shuffledQuestions: [],
    timer: null,
    timeLeft: 0,
    isPaused: false,
    totalQuestionsPerGame: 15,
    timePerQuestion: 20,
    // VK Integration State
    isVK: false,
    vkUserId: null,
    gamesPlayedSinceAd: 0
};

let stats = {};

// --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
const screens = {
    'main-menu': document.getElementById('main-menu'),
    'category-selection': document.getElementById('category-selection'),
    'game-screen': document.getElementById('game-screen'),
    'stats-screen': document.getElementById('stats-screen'),
    'game-over-screen': document.getElementById('game-over-screen'),
    'rules-screen': document.getElementById('rules-screen'),
    'themes-screen': document.getElementById('themes-screen')
};
const questionTextEl = document.getElementById('question-text');
const optionsContainerEl = document.getElementById('options-container');
const scoreEl = document.getElementById('score');
const questionCounterEl = document.getElementById('question-counter');
const timerBarEl = document.getElementById('timer-bar');
const pauseOverlayEl = document.getElementById('pause-overlay');

// --- –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø VK BRIDGE ---
async function initVK() {
    try {
        await vkBridge.send('VKWebAppInit');
        appState.isVK = true;
        const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
        appState.vkUserId = userInfo.id;
        console.log('VK Bridge initialized for user:', appState.vkUserId);
    } catch (error) {
        console.error('VK Bridge init failed:', error);
        appState.isVK = false;
    }
    await loadStats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
}

async function saveStats() {
    const dataString = JSON.stringify(stats);
    // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
    localStorage.setItem(STATS_VK_KEY, dataString);

    if (appState.isVK && appState.vkUserId) {
        try {
            await vkBridge.send('VKWebAppStorageSet', { key: STATS_VK_KEY, value: dataString });
            console.log('Stats saved to VK Storage');
        } catch (e) {
            console.error('VK Storage save failed:', e);
        }
    }
}

async function loadStats() {
    let loadedData = null;
    if (appState.isVK && appState.vkUserId) {
        try {
            const data = await vkBridge.send('VKWebAppStorageGet', { keys: [STATS_VK_KEY] });
            if (data.keys[0].value) {
                loadedData = data.keys[0].value;
                console.log('Stats loaded from VK Storage');
            }
        } catch (e) {
            console.error('VK Storage load failed:', e);
        }
    }

    if (!loadedData) {
        loadedData = localStorage.getItem(STATS_VK_KEY);
        if (loadedData) console.log('Stats loaded from localStorage');
    }

    stats = loadedData ? JSON.parse(loadedData) : initStats();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    for (const category in questions) {
        if (!stats[category]) {
            stats[category] = { totalQuestionsAnswered: 0, totalCorrect: 0, highScore: 0 };
        }
    }
}


// --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

function showScreen(screenId) {
    if (appState.isPaused) {
        togglePause();
    }
    if (appState.currentScreen === 'game-screen' && screenId !== 'game-screen') {
        clearInterval(appState.timer);
    }

    Object.values(screens).forEach(screen => screen.classList.add('hidden'));
    screens[screenId].classList.remove('hidden');
    appState.currentScreen = screenId;

    if (appState.isVK) {
        vkBridge.send("VKWebAppShowBannerAd", { banner_location: 'bottom' })
            .catch(e => console.error("Banner Ad Error:", e));
    }

    if (screenId === 'stats-screen') {
        displayStats();
    }
    if (screenId === 'main-menu' || screenId === 'category-selection') {
        resetGameState();
    }
}

function setTheme(themeName) {
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('theme', themeName);
}

function initCategories() {
    const categoryContainer = document.getElementById('category-grid');
    const categoryColors = {
        "–ù–∞—É–∫–∞": "#3b82f6",
        "–ò—Å—Ç–æ—Ä–∏—è": "#f59e0b",
        "–ò—Å–∫—É—Å—Å—Ç–≤–æ": "#8b5cf6",
        "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è": "#22c55e",
        "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è": "#ef4444"
    };
    categoryContainer.innerHTML = '';
    for (const category in questions) {
        const button = document.createElement('button');
        button.className = `w-full text-white font-bold py-4 px-4 rounded-xl text-xl shadow-lg btn-fx`;
        button.style.backgroundColor = categoryColors[category] || 'var(--accent-primary)';
        button.textContent = category;
        button.onclick = () => startGame(category);
        categoryContainer.appendChild(button);
    }
}

function initStats() {
    const defaultCategoryStats = { totalQuestionsAnswered: 0, totalCorrect: 0, highScore: 0 };
    const initialStats = {};
    for (const category in questions) {
        initialStats[category] = { ...defaultCategoryStats };
    }
    return initialStats;
}

function displayStats() {
    const statsContent = document.getElementById('stats-content');
    let statsHtml = '';
    const categories = Object.keys(questions);
    if (categories.every(cat => !stats[cat] || stats[cat].totalQuestionsAnswered === 0)) {
        statsHtml = `<div class="text-center h-full flex items-center justify-center" style="color: var(--text-secondary);"><p>–í—ã –µ—â–µ –Ω–µ –∏–≥—Ä–∞–ª–∏.<br>–°—ã–≥—Ä–∞–π—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!</p></div>`;
    } else {
        for (const category of categories) {
            const catStats = stats[category];
            const accuracy = catStats.totalQuestionsAnswered > 0 ? ((catStats.totalCorrect / catStats.totalQuestionsAnswered) * 100).toFixed(1) : 0;
            statsHtml += `
            <div class="p-4 rounded-lg" style="background-color: var(--bg-primary);">
            <h3 class="text-xl font-bold mb-2" style="color: var(--accent-primary);">${category}</h3>
            <div class="space-y-1 text-sm" style="color: var(--text-secondary);">
            <p class="flex justify-between"><span>–†–µ–∫–æ—Ä–¥ –æ—á–∫–æ–≤:</span> <span class="font-semibold" style="color: var(--text-primary);">${catStats.highScore}</span></p>
            <p class="flex justify-between"><span>–û—Ç–≤–µ—á–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤:</span> <span class="font-semibold" style="color: var(--text-primary);">${catStats.totalQuestionsAnswered}</span></p>
            <p class="flex justify-between"><span>–¢–æ—á–Ω–æ—Å—Ç—å:</span> <span class="font-semibold" style="color: var(--text-primary);">${accuracy}%</span></p>
            </div>
            </div>`;
        }
    }
    statsContent.innerHTML = statsHtml;
}

function resetGameState() {
    appState.currentCategory = '';
    appState.currentQuestionIndex = 0;
    appState.score = 0;
    appState.correctAnswers = 0;
    appState.incorrectAnswers = 0;
    appState.shuffledQuestions = [];
    clearInterval(appState.timer);
    appState.isPaused = false;
}

function startGame(category) {
    resetGameState();
    appState.currentCategory = category;
    const categoryQuestions = [...questions[category]];
    appState.shuffledQuestions = categoryQuestions.sort(() => 0.5 - Math.random()).slice(0, appState.totalQuestionsPerGame);
    showScreen('game-screen');
    displayNextQuestion();
}

function displayNextQuestion() {
    if (appState.currentQuestionIndex >= appState.shuffledQuestions.length) {
        endGame();
        return;
    }
    const question = appState.shuffledQuestions[appState.currentQuestionIndex];
    questionTextEl.textContent = question.question;
    optionsContainerEl.innerHTML = '';
    const shuffledOptions = [...question.options].sort(() => 0.5 - Math.random());
    shuffledOptions.forEach(option => {
        const button = document.createElement('button');
        button.className = "option-btn w-full text-left p-4 rounded-lg border-2 border-transparent focus:outline-none focus:ring-2 transition-all duration-200";
        button.style.backgroundColor = 'var(--bg-tertiary)';
        button.style.borderColor = 'var(--bg-tertiary)';
        button.textContent = option;
        button.onclick = () => selectAnswer(button, option, question.answer);
        optionsContainerEl.appendChild(button);
    });
    scoreEl.textContent = `–û—á–∫–∏: ${appState.score}`;
    questionCounterEl.textContent = `–í–æ–ø—Ä–æ—Å ${appState.currentQuestionIndex + 1} / ${appState.shuffledQuestions.length}`;
    startTimer();
}

function startTimer() {
    clearInterval(appState.timer);
    appState.timeLeft = appState.timePerQuestion;
    timerBarEl.style.width = '100%';
    appState.timer = setInterval(() => {
        if (appState.isPaused) return;
        appState.timeLeft--;
        const widthPercentage = (appState.timeLeft / appState.timePerQuestion) * 100;
        timerBarEl.style.width = `${widthPercentage}%`;
        if (appState.timeLeft <= 0) {
            clearInterval(appState.timer);
            handleTimeOut();
        }
    }, 1000);
}

function selectAnswer(selectedButton, selectedOption, correctAnswer) {
    clearInterval(appState.timer);
    const allButtons = optionsContainerEl.querySelectorAll('button');
    allButtons.forEach(btn => btn.disabled = true);
    const isCorrect = selectedOption === correctAnswer;

    stats[appState.currentCategory].totalQuestionsAnswered++;
    if (isCorrect) {
        appState.score += 100 + (appState.timeLeft * 5);
        appState.correctAnswers++;
        selectedButton.classList.add('correct');
        stats[appState.currentCategory].totalCorrect++;
    } else {
        appState.incorrectAnswers++;
        selectedButton.classList.add('incorrect');
        allButtons.forEach(btn => {
            if (btn.textContent === correctAnswer) btn.classList.add('correct');
        });
    }
    saveStats();
    setTimeout(() => {
        appState.currentQuestionIndex++;
        displayNextQuestion();
    }, 1500);
}

function handleTimeOut() {
    appState.incorrectAnswers++;
    stats[appState.currentCategory].totalQuestionsAnswered++;
    saveStats();
    const allButtons = optionsContainerEl.querySelectorAll('button');
    allButtons.forEach(btn => {
        btn.disabled = true;
        const correctAnswer = appState.shuffledQuestions[appState.currentQuestionIndex].answer;
        if (btn.textContent === correctAnswer) btn.classList.add('correct');
        else btn.style.opacity = '0.5';
    });
    setTimeout(() => {
        appState.currentQuestionIndex++;
        displayNextQuestion();
    }, 1500);
}

function endGame() {
    showScreen('game-over-screen');
    document.getElementById('final-score').textContent = appState.score;
    document.getElementById('results-summary').innerHTML = `
    <p class="flex justify-between"><span>‚úîÔ∏è –ü—Ä–∞–≤–∏–ª—å–Ω–æ:</span> <span>${appState.correctAnswers}</span></p>
    <p class="flex justify-between"><span>‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:</span> <span>${appState.incorrectAnswers}</span></p>`;

    if (appState.score > stats[appState.currentCategory].highScore) {
        stats[appState.currentCategory].highScore = appState.score;
    }
    saveStats();

    // –ü–æ–∫–∞–∑ –º–µ–∂—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã
    appState.gamesPlayedSinceAd++;
    if (appState.isVK && appState.gamesPlayedSinceAd >= 2) {
        vkBridge.send('VKWebAppShowNativeAds', { ad_format: 'interstitial' })
            .then(data => {
                if (data.result) {
                    console.log("Interstitial Ad was shown");
                } else {
                    console.log("Interstitial Ad was not shown");
                }
            })
            .catch(e => console.error("Interstitial Ad Error:", e));
        appState.gamesPlayedSinceAd = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    }
}

function restartGame() {
    if (appState.currentCategory) {
        startGame(appState.currentCategory);
    } else {
        showScreen('main-menu');
    }
}

function togglePause() {
    appState.isPaused = !appState.isPaused;
    pauseOverlayEl.classList.toggle('hidden');
    pauseOverlayEl.classList.toggle('flex');
}

document.addEventListener('DOMContentLoaded', async () => {
    // –ó–∞–ø—Ä–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    document.body.addEventListener('contextmenu', (event) => {
        event.preventDefault();
    });

    const savedTheme = localStorage.getItem('theme') || 'dark';
    setTheme(savedTheme);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VK Bridge –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await initVK();
    
    initCategories();
    showScreen('main-menu');
});
</script>
</body>
</html>